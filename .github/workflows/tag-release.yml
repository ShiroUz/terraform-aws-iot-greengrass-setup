name: Tag Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0, 1.1.0, 2.0.0)'
        required: true
        type: string
      release_type:
        description: 'Type of release'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write
  pull-requests: read

jobs:
  manual-release:
    name: Create Manual Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          if git rev-parse "v${{ github.event.inputs.version }}" >/dev/null 2>&1; then
            echo "Error: Tag v${{ github.event.inputs.version }} already exists"
            exit 1
          fi

      - name: Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found. This will be the first release."
          else
            echo "Previous tag: $PREV_TAG"
          fi

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          git tag -a "v${{ github.event.inputs.version }}" -m "Release v${{ github.event.inputs.version }}"
          git push origin "v${{ github.event.inputs.version }}"

      - name: Generate release notes with Release Drafter
        id: release_drafter
        uses: release-drafter/release-drafter@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-name: release-drafter.yml
          version: ${{ github.event.inputs.version }}
          tag: v${{ github.event.inputs.version }}
          name: v${{ github.event.inputs.version }}
          publish: true
          prerelease: false

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DATE=$(date +%Y-%m-%d)
          PREV_TAG="${{ steps.previous_tag.outputs.previous_tag }}"

          # Get the release body from the created release
          RELEASE_NOTES=$(gh release view "v$VERSION" --json body -q .body)

          # Create installation instructions
          INSTALL_SECTION=$(cat <<EOF
          ## Installation

          ### HCP Terraform (Terraform Cloud)

          \`\`\`hcl
          module "iot_greengrass" {
            source  = "ShiroUz/terraform-aws-iot-greengrass-setup/aws"
            version = "$VERSION"

            # Your configuration here
          }
          \`\`\`

          ### GitHub Source

          \`\`\`hcl
          module "iot_greengrass" {
            source = "git::https://github.com/ShiroUz/terraform-aws-iot-greengrass-setup.git?ref=v$VERSION"

            # Your configuration here
          }
          \`\`\`
          EOF
          )

          # Create new changelog entry with release notes and installation instructions
          {
            echo "## [Unreleased]"
            echo ""
            echo "## [$VERSION] - $DATE"
            echo ""
            echo "$RELEASE_NOTES"
            echo ""
            echo "$INSTALL_SECTION"
            echo ""
            tail -n +2 CHANGELOG.md
          } > CHANGELOG.md.new
          mv CHANGELOG.md.new CHANGELOG.md

          # Update links at bottom
          if [ -z "$PREV_TAG" ]; then
            echo "" >> CHANGELOG.md
            echo "[Unreleased]: https://github.com/ShiroUz/terraform-aws-iot-greengrass-setup/compare/v$VERSION...HEAD" >> CHANGELOG.md
            echo "[$VERSION]: https://github.com/ShiroUz/terraform-aws-iot-greengrass-setup/releases/tag/v$VERSION" >> CHANGELOG.md
          else
            sed -i "s|\[Unreleased\]:.*|[Unreleased]: https://github.com/ShiroUz/terraform-aws-iot-greengrass-setup/compare/v$VERSION...HEAD\n[$VERSION]: https://github.com/ShiroUz/terraform-aws-iot-greengrass-setup/compare/$PREV_TAG...v$VERSION|" CHANGELOG.md
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push CHANGELOG
        run: |
          git add CHANGELOG.md
          git commit -m "chore(release): update CHANGELOG for ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push origin main || git push origin master
